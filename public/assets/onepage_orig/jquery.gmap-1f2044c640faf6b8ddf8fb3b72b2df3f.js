!function(o){"use strict";var e=function(){this.markers=[],this.mainMarker=!1,this.icon="http://www.google.com/mapfiles/marker.png"};e.prototype.dist=function(o){return Math.sqrt(Math.pow(this.markers[0].latitude-o.latitude,2)+Math.pow(this.markers[0].longitude-o.longitude,2))},e.prototype.setIcon=function(o){this.icon=o},e.prototype.addMarker=function(o){this.markers[this.markers.length]=o},e.prototype.getMarker=function(){if(this.mainmarker)return this.mainmarker;var o,e;return this.markers.length>1?(o=new t.MarkerImage("http://thydzik.com/thydzikGoogleMap/markerlink.php?text="+this.markers.length+"&color=EF9D3F"),e="cluster of "+this.markers.length+" markers"):(o=new t.MarkerImage(this.icon),e=this.markers[0].title),this.mainmarker=new t.Marker({position:new t.LatLng(this.markers[0].latitude,this.markers[0].longitude),icon:o,title:e,map:null}),this.mainmarker};var t=google.maps,n=new t.Geocoder,i=0,r=0,a={};a={init:function(e){var n,i=o.extend({},o.fn.gMap.defaults,e);for(n in o.fn.gMap.defaults.icon)i.icon[n]||(i.icon[n]=o.fn.gMap.defaults.icon[n]);return this.each(function(){var e,n,r=o(this),s=a._getMapCenter.apply(r,[i]);"fit"==i.zoom&&(i.zoomFit=!0,i.zoom=a._autoZoom.apply(r,[i]));var l={zoom:i.zoom,center:s,mapTypeControl:i.mapTypeControl,mapTypeControlOptions:{},zoomControl:i.zoomControl,zoomControlOptions:{},panControl:i.panControl,panControlOptions:{},scaleControl:i.scaleControl,scaleControlOptions:{},streetViewControl:i.streetViewControl,streetViewControlOptions:{},mapTypeId:i.maptype,scrollwheel:i.scrollwheel,maxZoom:i.maxZoom,minZoom:i.minZoom};i.controlsPositions.mapType&&(l.mapTypeControlOptions.position=i.controlsPositions.mapType),i.controlsPositions.zoom&&(l.zoomControlOptions.position=i.controlsPositions.zoom),i.controlsPositions.pan&&(l.panControlOptions.position=i.controlsPositions.pan),i.controlsPositions.scale&&(l.scaleControlOptions.position=i.controlsPositions.scale),i.controlsPositions.streetView&&(l.streetViewControlOptions.position=i.controlsPositions.streetView),l.mapTypeControlOptions.style=i.controlsStyle.mapType,l.zoomControlOptions.style=i.controlsStyle.zoom;var c=new t.Map(this,l);if(i.log&&console.log("map center is:"),i.log&&console.log(s),r.data("$gmap",c),r.data("gmap",{opts:i,gmap:c,markers:[],markerKeys:{},infoWindow:null,clusters:[]}),0!==i.controls.length)for(e=0;e<i.controls.length;e+=1)c.controls[i.controls[e].pos].push(i.controls[e].div);i.clustering.enabled?(n=r.data("gmap"),function(o){n.markers=o}(i.markers),a._renderCluster.apply(r,[]),t.event.addListener(c,"bounds_changed",function(){a._renderCluster.apply(r,[])})):0!==i.markers.length&&a.addMarkers.apply(r,[i.markers]),a._onComplete.apply(r,[])})},_delayedMode:!1,_onComplete:function(){var o=this.data("gmap"),e=this;if(0!==i)return window.setTimeout(function(){a._onComplete.apply(e,[])},100),void 0;if(a._delayedMode){var t=a._getMapCenter.apply(this,[o.opts,!0]);if(a._setMapCenter.apply(this,[t]),o.opts.zoomFit){var n=a._autoZoom.apply(this,[o.opts,!0]);o.gmap.setZoom(n)}}o.opts.onComplete()},_setMapCenter:function(o){var e=this.data("gmap");if(e.opts.log&&console.log("delayed setMapCenter called"),void 0!==e.gmap&&0==i)e.gmap.setCenter(o);else{var t=this;window.setTimeout(function(){a._setMapCenter.apply(t,[o])},100)}},_boundaries:null,_getBoundaries:function(o){var e,t=o.markers,n=1e3,i=-1e3,r=1e3,s=-1e3;if(t){for(e=0;e<t.length;e+=1)t[e].latitude&&t[e].longitude&&(n>t[e].latitude&&(n=t[e].latitude),i<t[e].longitude&&(i=t[e].longitude),r>t[e].longitude&&(r=t[e].longitude),s<t[e].latitude&&(s=t[e].latitude),console.log(t[e].latitude,t[e].longitude,n,i,r,s));a._boundaries={N:n,E:i,W:r,S:s}}return-1e3==n&&(a._boundaries={N:0,E:0,W:0,S:0}),a._boundaries},_getBoundariesFromMarkers:function(){var o,e=this.data("gmap").markers,t=1e3,n=-1e3,i=1e3,r=-1e3;if(e){for(o=0;o<e.length;o+=1)t>e[o].getPosition().lat()&&(t=e[o].getPosition().lat()),n<e[o].getPosition().lng()&&(n=e[o].getPosition().lng()),i>e[o].getPosition().lng()&&(i=e[o].getPosition().lng()),r<e[o].getPosition().lat()&&(r=e[o].getPosition().lat());a._boundaries={N:t,E:n,W:i,S:r}}return-1e3==t&&(a._boundaries={N:0,E:0,W:0,S:0}),a._boundaries},_getMapCenter:function(o,e){var i,r,s,l,c=this;if(o.markers.length&&("fit"==o.latitude||"fit"==o.longitude))return l=e?a._getBoundariesFromMarkers.apply(this):a._getBoundaries(o),i=new t.LatLng((l.N+l.S)/2,(l.E+l.W)/2),console.log(e,l,i),i;if(o.latitude&&o.longitude)return i=new t.LatLng(o.latitude,o.longitude);if(i=new t.LatLng(0,0),o.address)return n.geocode({address:o.address},function(e,t){t===google.maps.GeocoderStatus.OK?a._setMapCenter.apply(c,[e[0].geometry.location]):o.log&&console.log("Geocode was not successful for the following reason: "+t)}),i;if(o.markers.length>0){for(s=null,r=0;r<o.markers.length;r+=1)if(o.markers[r].setCenter){s=o.markers[r];break}if(null===s)for(r=0;r<o.markers.length;r+=1){if(o.markers[r].latitude&&o.markers[r].longitude){s=o.markers[r];break}o.markers[r].address&&(s=o.markers[r])}if(null===s)return i;if(s.latitude&&s.longitude)return new t.LatLng(s.latitude,s.longitude);s.address&&n.geocode({address:s.address},function(e,t){t===google.maps.GeocoderStatus.OK?a._setMapCenter.apply(c,[e[0].geometry.location]):o.log&&console.log("Geocode was not successful for the following reason: "+t)})}return i},_renderCluster:function(){var o,t,n,i=this.data("gmap"),r=i.markers,s=i.clusters,l=i.opts;for(o=0;o<s.length;o+=1)s[o].getMarker().setMap(null);if(s.length=0,n=i.gmap.getBounds(),!n){var c=this;return window.setTimeout(function(){a._renderCluster.apply(c)},1e3),void 0}var d,p,g,u,m=n.getNorthEast(),h=n.getSouthWest(),f=m.lat()-h.lat(),w=[],y=f*l.clustering.clusterSize/100;for(o=0;o<r.length;o+=1)r[o].latitude<m.lat()&&r[o].latitude>h.lat()&&r[o].longitude<m.lng()&&r[o].longitude>h.lng()&&(w[w.length]=r[o]);for(l.log&&console.log("number of markers "+w.length+"/"+r.length),l.log&&console.log("cluster radius: "+y),o=0;o<w.length;o+=1){for(p=1e4,d=-1,t=0;t<s.length&&(g=s[t].dist(w[o]),!(y>g&&(p=g,d=t,l.clustering.fastClustering)));t+=1);-1===d?(u=new e,u.addMarker(w[o]),s[s.length]=u):s[d].addMarker(w[o])}for(l.log&&console.log("Total clusters in viewport: "+s.length),t=0;t<s.length;t+=1)s[t].getMarker().setMap(i.gmap)},_processMarker:function(o,e,n,i){var r,a,s=this.data("gmap"),l=s.gmap,c=s.opts;if(void 0===i&&(i=new t.LatLng(o.latitude,o.longitude)),!e){var d={image:c.icon.image,iconSize:new t.Size(c.icon.iconsize[0],c.icon.iconsize[1]),iconAnchor:new t.Point(c.icon.iconanchor[0],c.icon.iconanchor[1]),infoWindowAnchor:new t.Size(c.icon.infowindowanchor[0],c.icon.infowindowanchor[1])};e=new t.MarkerImage(d.image,d.iconSize,null,d.iconAnchor)}n||{image:c.icon.shadow,iconSize:new t.Size(c.icon.shadowsize[0],c.icon.shadowsize[1]),anchor:d&&d.iconAnchor?d.iconAnchor:new t.Point(c.icon.iconanchor[0],c.icon.iconanchor[1])},a={position:i,icon:e,title:o.title,map:null,draggable:o.draggable===!0?!0:!1},c.clustering.enabled||(a.map=l),r=new t.Marker(a),r.setShadow(n),s.markers.push(r),o.key&&(s.markerKeys[o.key]=r);var p;if(o.html){var g="string"==typeof o.html?c.html_prepend+o.html+c.html_append:o.html,u={content:g,pixelOffset:o.infoWindowAnchor};c.log&&console.log("setup popup with data"),c.log&&console.log(u),p=new t.InfoWindow(u),t.event.addListener(r,"click",function(){c.log&&console.log("opening popup "+o.html),c.singleInfoWindow&&s.infoWindow&&s.infoWindow.close(),p.open(l,r),s.infoWindow=p})}o.html&&o.popup&&(c.log&&console.log("opening popup "+o.html),p.open(l,r),s.infoWindow=p),o.onDragEnd&&t.event.addListener(r,"dragend",function(e){c.log&&console.log("drag end"),o.onDragEnd(e)})},_geocodeMarker:function(o,e,s){var l=this;n.geocode({address:o.address},function(n,c){c===t.GeocoderStatus.OK?(i-=1,l.data("gmap").opts.log&&console.log("Geocode was successful with point: ",n[0].geometry.location),a._processMarker.apply(l,[o,e,s,n[0].geometry.location])):(c===t.GeocoderStatus.OVER_QUERY_LIMIT&&(l.data("gmap").opts.noAlerts||0!==r||alert("Error: too many geocoded addresses! Switching to 1 marker/s mode."),r+=1e3,window.setTimeout(function(){a._geocodeMarker.apply(l,[o,e,s])},r)),l.data("gmap").opts.log&&console.log("Geocode was not successful for the following reason: "+c))})},_autoZoom:function(e,t){var n,i,r,s,l=o(this).data("gmap"),c=o.extend({},l?l.opts:{},e),d=39135.758482;for(c.log&&console.log("autozooming map"),i=t?a._getBoundariesFromMarkers.apply(this):a._getBoundaries(c),r=111e3*(i.E-i.W)/this.width(),s=111e3*(i.S-i.N)/this.height(),n=2;20>n&&!(r>d||s>d);n+=1)d/=2;return n-2},addMarkers:function(o){var e=this.data("gmap").opts;if(0!==o.length){e.log&&console.log("adding "+o.length+" markers");for(var t=0;t<o.length;t+=1)a.addMarker.apply(this,[o[t]])}},addMarker:function(o){var e=this.data("gmap").opts;e.log&&console.log("putting marker at "+o.latitude+", "+o.longitude+" with address "+o.address+" and html "+o.html);var n={image:e.icon.image,iconSize:new t.Size(e.icon.iconsize[0],e.icon.iconsize[1]),iconAnchor:new t.Point(e.icon.iconanchor[0],e.icon.iconanchor[1]),infoWindowAnchor:new t.Size(e.icon.infowindowanchor[0],e.icon.infowindowanchor[1])},r={image:e.icon.shadow,iconSize:new t.Size(e.icon.shadowsize[0],e.icon.shadowsize[1]),anchor:new t.Point(e.icon.shadowanchor[0],e.icon.shadowanchor[1])};o.infoWindowAnchor=n.infoWindowAnchor,o.icon&&(o.icon.image&&(n.image=o.icon.image),o.icon.iconsize&&(n.iconSize=new t.Size(o.icon.iconsize[0],o.icon.iconsize[1])),o.icon.iconanchor&&(n.iconAnchor=new t.Point(o.icon.iconanchor[0],o.icon.iconanchor[1])),o.icon.infowindowanchor&&(n.infoWindowAnchor=new t.Size(o.icon.infowindowanchor[0],o.icon.infowindowanchor[1])),o.icon.shadow&&(r.image=o.icon.shadow),o.icon.shadowsize&&(r.iconSize=new t.Size(o.icon.shadowsize[0],o.icon.shadowsize[1])),o.icon.shadowanchor&&(r.anchor=new t.Point(o.icon.shadowanchor[0],o.icon.shadowanchor[1])));var s=new t.MarkerImage(n.image,n.iconSize,null,n.iconAnchor),l=new t.MarkerImage(r.image,r.iconSize,null,r.anchor);if(o.address)"_address"===o.html&&(o.html=o.address),"_address"==o.title&&(o.title=o.address),e.log&&console.log("geocoding marker: "+o.address),i+=1,a._delayedMode=!0,a._geocodeMarker.apply(this,[o,s,l]);else{"_latlng"===o.html&&(o.html=o.latitude+", "+o.longitude),"_latlng"==o.title&&(o.title=o.latitude+", "+o.longitude);var c=new t.LatLng(o.latitude,o.longitude);a._processMarker.apply(this,[o,s,l,c])}},removeAllMarkers:function(){var o,e=this.data("gmap").markers;for(o=0;o<e.length;o+=1)e[o].setMap(null),delete e[o];e.length=0},getMarker:function(o){return this.data("gmap").markerKeys[o]},fixAfterResize:function(o){var e=this.data("gmap");t.event.trigger(e.gmap,"resize"),o&&e.gmap.panTo(new google.maps.LatLng(0,0)),e.gmap.panTo(this.gMap("_getMapCenter",e.opts))},setZoom:function(o,e,t){var n=this.data("gmap").gmap;"fit"===o&&(o=a._autoZoom.apply(this,[e,t])),n.setZoom(parseInt(o))},changeSettings:function(o){var e,t=this.data("gmap"),n=[];for(e=0;e<t.markers.length;e+=1)n[e]={latitude:t.markers[e].getPosition().lat(),longitude:t.markers[e].getPosition().lng()};o.markers=n,o.zoom&&a.setZoom.apply(this,[o.zoom,o]),(o.latitude||o.longitude)&&t.gmap.panTo(a._getMapCenter.apply(this,[o]))},mapclick:function(o){google.maps.event.addListener(this.data("gmap").gmap,"click",function(e){o(e.latLng)})},geocode:function(o,e,i){n.geocode({address:o},function(o,n){n===t.GeocoderStatus.OK?e(o[0].geometry.location):i&&i(o,n)})},getRoute:function(e){var n=this.data("gmap"),i=n.gmap,r=new t.DirectionsRenderer,a=new t.DirectionsService,s={BYCAR:t.DirectionsTravelMode.DRIVING,BYBICYCLE:t.DirectionsTravelMode.BICYCLING,BYFOOT:t.DirectionsTravelMode.WALKING},l={MILES:t.DirectionsUnitSystem.IMPERIAL,KM:t.DirectionsUnitSystem.METRIC},c=null,d=null,p=null;void 0!==e.routeDisplay?c=e.routeDisplay instanceof jQuery?e.routeDisplay[0]:"string"==typeof e.routeDisplay?o(e.routeDisplay)[0]:null:null!==n.opts.routeFinder.routeDisplay&&(c=n.opts.routeFinder.routeDisplay instanceof jQuery?n.opts.routeFinder.routeDisplay[0]:"string"==typeof n.opts.routeFinder.routeDisplay?o(n.opts.routeFinder.routeDisplay)[0]:null),r.setMap(i),null!==c&&r.setPanel(c),d=void 0!==s[n.opts.routeFinder.travelMode]?s[n.opts.routeFinder.travelMode]:s.BYCAR,p=void 0!==l[n.opts.routeFinder.travelUnit]?l[n.opts.routeFinder.travelUnit]:l.KM;var g={origin:e.from,destination:e.to,travelMode:d,unitSystem:p};return a.route(g,function(e,i){i==t.DirectionsStatus.OK?r.setDirections(e):null!==c&&o(c).html(n.opts.routeFinder.routeErrors[i])}),this}},o.fn.gMap=function(e){return a[e]?a[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?(o.error("Method "+e+" does not exist on jQuery.gmap"),void 0):a.init.apply(this,arguments)},o.fn.gMap.defaults={log:!1,address:"",latitude:null,longitude:null,zoom:3,maxZoom:null,minZoom:null,markers:[],controls:{},scrollwheel:!0,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,zoomControl:!0,panControl:!1,scaleControl:!1,streetViewControl:!0,controlsPositions:{mapType:null,zoom:null,pan:null,scale:null,streetView:null},controlsStyle:{mapType:google.maps.MapTypeControlStyle.DEFAULT,zoom:google.maps.ZoomControlStyle.DEFAULT},singleInfoWindow:!0,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2],shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34],shadowanchor:[9,34]},onComplete:function(){},routeFinder:{travelMode:"BYCAR",travelUnit:"KM",routeDisplay:null,routeErrors:{INVALID_REQUEST:"The provided request is invalid.",NOT_FOUND:"One or more of the given addresses could not be found.",OVER_QUERY_LIMIT:"A temporary error occured. Please try again in a few minutes.",REQUEST_DENIED:"An error occured. Please contact us.",UNKNOWN_ERROR:"An unknown error occured. Please try again.",ZERO_RESULTS:"No route could be found within the given addresses."}},clustering:{enabled:!1,fastClustering:!1,clusterCount:10,clusterSize:40}}}(jQuery);